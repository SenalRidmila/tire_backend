<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔄 Complete Email Workflow - Tire Management</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .workflow-step {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #00b894;
        }
        .btn {
            background: #00b894;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #00a085; }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .success { background: rgba(0, 184, 148, 0.3); }
        .error { background: rgba(231, 76, 60, 0.3); }
        .info { background: rgba(116, 185, 255, 0.3); }
        .email-preview {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 Complete Email Workflow System</h1>
        <p><strong>4-Step Email Notification Chain</strong></p>

        <div id="status" class="status info">
            📧 Ready to test complete email workflow...
        </div>

        <div class="workflow-step">
            <h3>📝 Step 1: User Submits Request</h3>
            <p><strong>Trigger:</strong> User submits tire request form</p>
            <p><strong>Email To:</strong> Manager (slthrmanager@gmail.com)</p>
            <p><strong>Dashboard Link:</strong> https://tire-slt.vercel.app/manager</p>
            
            <div class="email-preview">
                <strong>Subject:</strong> 🚗 New Tire Request - [Vehicle No]<br>
                <strong>Content:</strong> New tire request needs your approval...<br>
                <strong>Action:</strong> <a href="#" style="color: #00b894;">View Manager Dashboard</a>
            </div>
            
            <button class="btn" onclick="testStep1()">📧 Test Step 1</button>
        </div>

        <div class="workflow-step">
            <h3>✅ Step 2: Manager Approves</h3>
            <p><strong>Trigger:</strong> Manager clicks approve in dashboard</p>
            <p><strong>Email To:</strong> TTO (tto@slt.lk)</p>
            <p><strong>Dashboard Link:</strong> https://tire-slt.vercel.app/tto</p>
            
            <div class="email-preview">
                <strong>Subject:</strong> 🎯 Manager Approved - TTO Review Required - [Vehicle No]<br>
                <strong>Content:</strong> Manager approved tire request, needs TTO review...<br>
                <strong>Action:</strong> <a href="#" style="color: #00b894;">View TTO Dashboard</a>
            </div>
            
            <button class="btn" onclick="testStep2()">📧 Test Step 2</button>
        </div>

        <div class="workflow-step">
            <h3>🔧 Step 3: TTO Approves</h3>
            <p><strong>Trigger:</strong> TTO approves in TTO dashboard</p>
            <p><strong>Email To:</strong> Engineer (engineer@slt.lk)</p>
            <p><strong>Dashboard Link:</strong> https://tire-slt.vercel.app/engineer</p>
            
            <div class="email-preview">
                <strong>Subject:</strong> ⚙️ TTO Approved - Engineering Review Required - [Vehicle No]<br>
                <strong>Content:</strong> TTO approved tire request, needs engineering review...<br>
                <strong>Action:</strong> <a href="#" style="color: #00b894;">View Engineer Dashboard</a>
            </div>
            
            <button class="btn" onclick="testStep3()">📧 Test Step 3</button>
        </div>

        <div class="workflow-step">
            <h3>🎉 Step 4: Engineer Approves</h3>
            <p><strong>Trigger:</strong> Engineer approves in engineering dashboard</p>
            <p><strong>Email To:</strong> Original User (from request form email)</p>
            <p><strong>Dashboard Link:</strong> https://tire-slt.vercel.app/orders</p>
            
            <div class="email-preview">
                <strong>Subject:</strong> ✅ Tire Request Approved - Order Processing - [Vehicle No]<br>
                <strong>Content:</strong> Your tire request has been fully approved...<br>
                <strong>Action:</strong> <a href="#" style="color: #00b894;">View Order Dashboard</a>
            </div>
            
            <button class="btn" onclick="testStep4()">📧 Test Step 4</button>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="testCompleteFlow()" style="font-size: 18px; padding: 15px 30px;">
                🔄 Test Complete Workflow
            </button>
        </div>

        <div class="workflow-step">
            <h3>📧 Email Templates Configuration</h3>
            <p>EmailJS වල මේ templates හදන්න:</p>
            <ul>
                <li><strong>template_manager</strong> - Step 1: User → Manager</li>
                <li><strong>template_tto</strong> - Step 2: Manager → TTO</li>
                <li><strong>template_engineer</strong> - Step 3: TTO → Engineer</li>
                <li><strong>template_user_final</strong> - Step 4: Engineer → User</li>
            </ul>
        </div>
    </div>

    <script>
        // EmailJS Configuration - Replace with your values
        const emailConfig = {
            serviceId: 'service_xxxxxxx',
            publicKey: 'your_public_key_here',
            templates: {
                manager: 'template_manager',      // Template for Manager notification
                tto: 'template_tto',            // Template for TTO notification  
                engineer: 'template_engineer',   // Template for Engineer notification
                userFinal: 'template_user_final' // Template for final user notification
            }
        };

        // Initialize EmailJS
        emailjs.init(emailConfig.publicKey);

        // Sample tire request data for testing
        const sampleRequest = {
            id: 'TEST-' + Date.now(),
            vehicleNo: 'CAB-1234',
            userSection: 'Transport Division',
            tireSize: '7.00 R16',
            userEmail: 'user@slt.lk',
            requestDate: new Date().toLocaleDateString()
        };

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = message;
            statusEl.className = `status ${type}`;
        }

        // Step 1: User submits → Manager notification
        async function testStep1() {
            updateStatus('📤 Sending Step 1: User → Manager notification...');
            
            const templateParams = {
                to_email: 'slthrmanager@gmail.com',
                subject: `🚗 New Tire Request - ${sampleRequest.vehicleNo}`,
                vehicle_no: sampleRequest.vehicleNo,
                user_section: sampleRequest.userSection,
                tire_size: sampleRequest.tireSize,
                request_id: sampleRequest.id,
                request_date: sampleRequest.requestDate,
                dashboard_link: 'https://tire-slt.vercel.app/manager',
                action_text: 'Review and Approve Request'
            };

            try {
                const result = await emailjs.send(emailConfig.serviceId, emailConfig.templates.manager, templateParams);
                updateStatus('✅ Step 1 completed: Manager notification sent!', 'success');
            } catch (error) {
                updateStatus('❌ Step 1 failed: Check EmailJS configuration', 'error');
                console.error('Step 1 error:', error);
            }
        }

        // Step 2: Manager approves → TTO notification
        async function testStep2() {
            updateStatus('📤 Sending Step 2: Manager → TTO notification...');
            
            const templateParams = {
                to_email: 'tto@slt.lk',
                subject: `🎯 Manager Approved - TTO Review Required - ${sampleRequest.vehicleNo}`,
                vehicle_no: sampleRequest.vehicleNo,
                user_section: sampleRequest.userSection,
                tire_size: sampleRequest.tireSize,
                request_id: sampleRequest.id,
                approval_date: new Date().toLocaleDateString(),
                approved_by: 'HR Manager',
                dashboard_link: 'https://tire-slt.vercel.app/tto',
                action_text: 'Review Technical Specifications'
            };

            try {
                const result = await emailjs.send(emailConfig.serviceId, emailConfig.templates.tto, templateParams);
                updateStatus('✅ Step 2 completed: TTO notification sent!', 'success');
            } catch (error) {
                updateStatus('❌ Step 2 failed: Check TTO template configuration', 'error');
                console.error('Step 2 error:', error);
            }
        }

        // Step 3: TTO approves → Engineer notification  
        async function testStep3() {
            updateStatus('📤 Sending Step 3: TTO → Engineer notification...');
            
            const templateParams = {
                to_email: 'engineer@slt.lk',
                subject: `⚙️ TTO Approved - Engineering Review Required - ${sampleRequest.vehicleNo}`,
                vehicle_no: sampleRequest.vehicleNo,
                user_section: sampleRequest.userSection,
                tire_size: sampleRequest.tireSize,
                request_id: sampleRequest.id,
                tto_approval_date: new Date().toLocaleDateString(),
                approved_by: 'TTO Officer',
                dashboard_link: 'https://tire-slt.vercel.app/engineer',
                action_text: 'Approve for Procurement'
            };

            try {
                const result = await emailjs.send(emailConfig.serviceId, emailConfig.templates.engineer, templateParams);
                updateStatus('✅ Step 3 completed: Engineer notification sent!', 'success');
            } catch (error) {
                updateStatus('❌ Step 3 failed: Check Engineer template configuration', 'error');
                console.error('Step 3 error:', error);
            }
        }

        // Step 4: Engineer approves → User final notification
        async function testStep4() {
            updateStatus('📤 Sending Step 4: Engineer → User final notification...');
            
            const templateParams = {
                to_email: sampleRequest.userEmail,
                subject: `✅ Tire Request Approved - Order Processing - ${sampleRequest.vehicleNo}`,
                vehicle_no: sampleRequest.vehicleNo,
                user_section: sampleRequest.userSection,
                tire_size: sampleRequest.tireSize,
                request_id: sampleRequest.id,
                final_approval_date: new Date().toLocaleDateString(),
                approved_by: 'Engineering Team',
                dashboard_link: 'https://tire-slt.vercel.app/orders',
                action_text: 'Track Order Status',
                estimated_delivery: '7-10 business days'
            };

            try {
                const result = await emailjs.send(emailConfig.serviceId, emailConfig.templates.userFinal, templateParams);
                updateStatus('🎉 Step 4 completed: User final notification sent!', 'success');
            } catch (error) {
                updateStatus('❌ Step 4 failed: Check User template configuration', 'error');
                console.error('Step 4 error:', error);
            }
        }

        // Test complete workflow with delays
        async function testCompleteFlow() {
            updateStatus('🔄 Testing complete email workflow... Please wait.');
            
            try {
                // Step 1
                await testStep1();
                await delay(2000);
                
                // Step 2
                await testStep2();
                await delay(2000);
                
                // Step 3
                await testStep3();
                await delay(2000);
                
                // Step 4
                await testStep4();
                
                updateStatus('🎉 Complete workflow test finished! Check all email inboxes.', 'success');
                
            } catch (error) {
                updateStatus('❌ Complete workflow failed. Check individual steps.', 'error');
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>